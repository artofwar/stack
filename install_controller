#!/bin/bash

TOP_DIR=$(cd $(dirname "$0") && pwd)

#install captcha
cd django-simple-captcha-0.3.0
sudo python setup.py install
cd ..

#install monitor related package and start services
cd kanyun/
sudo ps ax|grep -v grep|grep kanyun-|awk '{print $1}'|xargs -L 1 kill -9
sudo apt-get -y install libzmq-dev python-setuptools python-mysqldb redis-server python-redis python-zmq
nohup ./kanyun-server > .kanyun-server.nohup&
nohup ./kanyun-worker >.kanyun-worker.nohup &
cd ..

#get available space
size=$(sudo df -m|grep '/$'|awk '{print $4}')
back_file_size=$[size/1024-400]

#install openstack
cd devstack
sudo killall screen
cat <<EOF >localrc
FLAT_INTERFACE=eth0
FIXED_RANGE=10.0.0.0/20
FIXED_NETWORK_SIZE=4096
FLOATING_RANGE=192.168.136.1/24
MULTI_HOST=1
MYSQL_PASSWORD=csdb123cnic
RABBIT_PASSWORD=csdb123cnic
SERVICE_PASSWORD=csdb123cnic
ADMIN_PASSWORD=csdb123cnic
SERVICE_TOKEN=csdb123cnic
ENABLED_SERVICES=g-api,g-reg,key,n-api,n-crt,n-obj,n-cpu,n-net,cinder,c-sch,c-api,c-vol,n-sch,n-novnc,n-xvnc,n-cauth,horizon,mysql,rabbit
VOLUME_BACKING_FILE_SIZE=$back_file_size
IMAGE_URLS=http://stackops.s3.amazonaws.com/images/centos-6.2-x86_64.img.tar.gz
EOF
./stack.sh
